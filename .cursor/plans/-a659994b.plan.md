<!-- a659994b-6e30-45b9-b463-624cbef3a143 f3edf45f-d500-47c2-b443-9f4c5dc46fa8 -->
# 剧本预测功能实现方案

## 功能概述

添加剧本预测功能，允许系统展示多种可能的价格走势路径。每个剧本包含：

- 预测的价格路径点（10-50根K线，中期预测）
- 概率/置信度
- 关键价位（支撑位、阻力位）
- 触发条件

剧本可以来自三种来源：策略算法、AI模型、用户手动分析。

## 后端实现

### 1. 数据模型层 (`backend/app/models/`)

**新增文件：`scenarios.py`**

- 创建 `ScenarioPricePoint` 模型：单个预测价格点（时间、价格）
- 创建 `ScenarioKeyLevel` 模型：关键价位（价格、类型：支撑/阻力、描述）
- 创建 `ScenarioData` 模型：完整剧本数据
- 基本信息：id、名称、描述、symbol、timeframe
- 来源：source_type（strategy/ai/user）、source_name
- 预测路径：price_points（List[ScenarioPricePoint]）
- 关键价位：key_levels（List[ScenarioKeyLevel]）
- 触发条件：trigger_condition（字符串描述）
- 概率/置信度：probability（0-1）
- 创建时间和基准价格

### 2. 数据库层 (`backend/app/core/database.py`)

**新增表定义：`ScenarioDB`**

- 字段：id、scenario_id、name、description、symbol、timeframe
- source_type、source_name、price_points（JSON）、key_levels（JSON）
- trigger_condition、probability、base_price、base_timestamp
- created_at、expires_at（剧本过期时间）
- 索引：symbol + timeframe + created_at

**新增Database类方法：**

- `insert_scenario(scenario: ScenarioData)` - 插入剧本
- `get_scenarios(symbol, timeframe, limit)` - 查询符号的所有有效剧本
- `get_scenario_by_id(scenario_id)` - 根据ID获取剧本
- `delete_scenario(scenario_id)` - 删除剧本
- `cleanup_expired_scenarios()` - 清理过期剧本

### 3. API层 (`backend/app/api/rest.py`)

**新增REST端点：**

- `GET /api/scenarios/{symbol}/{timeframe}` - 获取剧本列表
- `GET /api/scenarios/{scenario_id}` - 获取单个剧本详情
- `POST /api/scenarios` - 创建新剧本（用户手动创建）
- `DELETE /api/scenarios/{scenario_id}` - 删除剧本

### 4. 可选：剧本生成器 (`backend/app/nodes/scenario_generator.py`)

**基于策略的剧本生成器（初始版本）：**

- 监听指标数据和K线数据
- 基于技术分析生成简单剧本：
- 上升趋势剧本（MA向上、RSI健康）
- 下降趋势剧本（MA向下、RSI超买）
- 震荡剧本（横盘整理）
- 自动计算支撑位/阻力位（基于历史高低点）
- 发布到消息总线并存入数据库

### 5. 数据库迁移 (`backend/alembic/versions/`)

创建新的Alembic迁移文件：

- 添加 scenarios 表
- 设置索引和约束

## 前端实现

### 1. 组件层 (`frontend/src/components/`)

**新增文件：`ScenarioPanel.jsx`**
剧本控制面板组件：

- 展示剧本列表（按钮形式）
- 每个按钮显示：剧本名称、来源标识、概率
- 点击按钮切换选中状态（同一时刻只有一个被选中）
- 选中时高亮按钮，触发图表更新
- 显示选中剧本的详细信息：
- 描述
- 触发条件
- 关键价位列表
- 来源信息

**修改文件：`TradingChart.jsx`**
增加剧本预测曲线渲染：

- 添加 `scenarioSeries` 到 seriesRef
- 新增方法 `updateScenarioLine(scenario)`：
- 接收剧本数据
- 使用 `addLineSeries` 创建预测线（不同颜色，半透明）
- 渲染价格路径点
- 新增方法 `clearScenarioLine()`：清除当前预测线
- 添加关键价位标记（使用 PriceLine API）

### 2. 状态管理 (`frontend/src/stores/`)

**新增文件：`scenarioStore.js`**
使用 Zustand 管理剧本状态：

- `scenarios`: 当前symbol的剧本列表
- `selectedScenario`: 当前选中的剧本
- `fetchScenarios(symbol, timeframe)`: 从API获取剧本
- `selectScenario(id)`: 选中某个剧本
- `createScenario(data)`: 创建新剧本
- `deleteScenario(id)`: 删除剧本

### 3. API服务 (`frontend/src/services/`)

**新增文件：`scenarioApi.js`**
封装剧本相关API调用：

- `getScenarios(symbol, timeframe)`
- `getScenarioById(id)`
- `createScenario(data)`
- `deleteScenario(id)`

### 4. 主应用集成 (`frontend/src/App.jsx`)

将ScenarioPanel组件添加到主界面：

- 位置：图表下方或右侧面板
- 传递symbol、timeframe参数
- 监听选中事件，更新图表

## 实现优先级

**阶段1（核心功能）：**

1. 后端数据模型和数据库表
2. 基础API端点（查询、创建、删除）
3. 前端ScenarioPanel组件
4. 图表预测线渲染

**阶段2（增强功能）：**

5. 策略自动生成剧本
6. 关键价位标记和可视化
7. 剧本过期清理机制

**阶段3（高级功能）：**

8. AI剧本生成接口预留
9. 剧本评估和历史回测
10. 剧本模板系统

### To-dos

- [ ] 创建剧本数据模型（scenarios.py），包含 ScenarioPricePoint、ScenarioKeyLevel、ScenarioData
- [ ] 在 database.py 中添加 ScenarioDB 表定义和相关CRUD方法
- [ ] 创建 Alembic 数据库迁移文件，添加 scenarios 表
- [ ] 在 rest.py 中添加剧本相关API端点（GET、POST、DELETE）
- [ ] 创建 scenarioApi.js 封装剧本API调用
- [ ] 创建 scenarioStore.js 使用 Zustand 管理剧本状态
- [ ] 创建 ScenarioPanel.jsx 组件，展示剧本列表和详情
- [ ] 修改 TradingChart.jsx 支持渲染预测曲线和关键价位
- [ ] 在 App.jsx 中集成 ScenarioPanel 组件
- [ ] 可选：创建基于策略的剧本自动生成器节点（scenario_generator.py）