<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight Charts é«˜çº§æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f0f1e;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #999;
            font-size: 1.2em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a3e;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #fff;
        }

        .chart-subtitle {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-badge.live {
            background: rgba(38, 166, 154, 0.2);
            color: #26a69a;
            animation: pulse 2s infinite;
        }

        .status-badge.paused {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #2a2a3e;
        }

        button.secondary:hover {
            background: #3a3a4e;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #2a2a3e;
        }

        .stat-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #fff;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: #26a69a;
        }

        .stat-change.negative {
            color: #ef5350;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .info-panel {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #667eea;
        }

        .info-panel h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .info-panel ul {
            list-style-position: inside;
            color: #999;
            line-height: 1.8;
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å®æ—¶äº¤æ˜“ä»ªè¡¨ç›˜</h1>
            <p>Lightweight Charts é«˜çº§åŠŸèƒ½æ¼”ç¤º</p>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">å½“å‰ä»·æ ¼</div>
                <div class="stat-value" id="current-price">$0.00</div>
                <div class="stat-change positive" id="price-change">+0.00%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">24h æˆäº¤é‡</div>
                <div class="stat-value" id="volume-24h">0</div>
                <div class="stat-change" id="volume-change">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">24h æœ€é«˜</div>
                <div class="stat-value" id="high-24h">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">24h æœ€ä½</div>
                <div class="stat-value" id="low-24h">$0.00</div>
            </div>
        </div>

        <div class="dashboard">
            <!-- å®æ—¶ä»·æ ¼å›¾è¡¨ -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ”´ å®æ—¶ä»·æ ¼ç›‘æ§</div>
                        <div class="chart-subtitle">æ¨¡æ‹Ÿ WebSocket å®æ—¶æ•°æ®æµ</div>
                    </div>
                    <span class="status-badge live" id="live-status">â— LIVE</span>
                </div>
                <div id="realtime-chart" class="chart-container"></div>
                <div class="controls">
                    <button id="toggle-realtime">æš‚åœå®æ—¶æ›´æ–°</button>
                    <button class="secondary" onclick="clearRealtimeData()">æ¸…ç©ºæ•°æ®</button>
                    <button class="secondary" onclick="changeInterval()">æ”¹å˜æ›´æ–°é¢‘ç‡</button>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2962FF;"></div>
                        <span>å®æ—¶ä»·æ ¼</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>EMA-12</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4ECDC4;"></div>
                        <span>EMA-26</span>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡ - RSI -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ“Š RSI æŒ‡æ ‡</div>
                        <div class="chart-subtitle">ç›¸å¯¹å¼ºå¼±æŒ‡æ•° (14å‘¨æœŸ)</div>
                    </div>
                </div>
                <div id="rsi-chart" class="chart-container"></div>
                <div class="info-panel">
                    <h4>RSI è§£è¯»</h4>
                    <ul>
                        <li>RSI > 70: è¶…ä¹°åŒºåŸŸ</li>
                        <li>RSI < 30: è¶…å–åŒºåŸŸ</li>
                        <li>RSI = 50: ä¸­æ€§åŒºåŸŸ</li>
                    </ul>
                </div>
            </div>

            <!-- æŠ€æœ¯æŒ‡æ ‡ - MACD -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ“‰ MACD æŒ‡æ ‡</div>
                        <div class="chart-subtitle">ç§»åŠ¨å¹³å‡æ”¶æ•›èƒŒç¦»æŒ‡æ ‡</div>
                    </div>
                </div>
                <div id="macd-chart" class="chart-container"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2962FF;"></div>
                        <span>MACD</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF6B6B;"></div>
                        <span>Signal</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #26a69a;"></div>
                        <span>Histogram</span>
                    </div>
                </div>
            </div>

            <!-- æ·±åº¦å›¾ -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">ğŸ’¹ è®¢å•æ·±åº¦å›¾</div>
                        <div class="chart-subtitle">ä¹°å–ç›˜åˆ†å¸ƒå¯è§†åŒ–</div>
                    </div>
                </div>
                <div id="depth-chart" class="chart-container"></div>
                <div class="controls">
                    <button onclick="updateDepthData()">åˆ·æ–°æ·±åº¦æ•°æ®</button>
                    <button class="secondary" onclick="toggleDepthAnimation()">åˆ‡æ¢åŠ¨ç”»</button>
                </div>
            </div>
        </div>
    </div>

    <script src="node_modules/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        // ç­‰å¾… DOM åŠ è½½å®Œæˆ
        window.addEventListener('DOMContentLoaded', function() {
            initCharts();
        });

        function initCharts() {
        // ========== å®æ—¶ä»·æ ¼å›¾è¡¨ ==========
        const realtimeChart = LightweightCharts.createChart(document.getElementById('realtime-chart'), {
            width: document.getElementById('realtime-chart').clientWidth,
            height: 400,
            layout: {
                background: { color: '#16161e' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2a3e' },
                horzLines: { color: '#2a2a3e' },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: true,
            },
        });

        const realtimeSeries = realtimeChart.addSeries(LightweightCharts.LineSeries, {
            color: '#2962FF',
            lineWidth: 2,
        });

        const ema12Series = realtimeChart.addSeries(LightweightCharts.LineSeries, {
            color: '#FF6B6B',
            lineWidth: 1,
        });

        const ema26Series = realtimeChart.addSeries(LightweightCharts.LineSeries, {
            color: '#4ECDC4',
            lineWidth: 1,
        });

        // æ•°æ®å­˜å‚¨
        let realtimeData = [];
        let ema12Data = [];
        let ema26Data = [];
        let currentPrice = 100;
        let isRealTimeActive = true;
        let updateInterval = 1000; // 1ç§’æ›´æ–°ä¸€æ¬¡

        // åˆå§‹åŒ–æ•°æ®
        function initializeRealtimeData() {
            const now = Math.floor(Date.now() / 1000);
            for (let i = 100; i >= 0; i--) {
                const time = now - i;
                currentPrice += (Math.random() - 0.5) * 2;
                realtimeData.push({ time, value: currentPrice });
            }
            realtimeSeries.setData(realtimeData);
            updateEMA();
        }

        // è®¡ç®— EMA
        function calculateEMA(data, period) {
            const k = 2 / (period + 1);
            const emaData = [];
            let ema = data[0].value;

            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    emaData.push({ time: data[i].time, value: ema });
                } else {
                    ema = data[i].value * k + ema * (1 - k);
                    emaData.push({ time: data[i].time, value: ema });
                }
            }
            return emaData;
        }

        function updateEMA() {
            ema12Data = calculateEMA(realtimeData, 12);
            ema26Data = calculateEMA(realtimeData, 26);
            ema12Series.setData(ema12Data);
            ema26Series.setData(ema26Data);
        }

        // å®æ—¶æ›´æ–°æ•°æ®
        function updateRealtimeData() {
            if (!isRealTimeActive) return;

            const lastPoint = realtimeData[realtimeData.length - 1];
            const newTime = lastPoint.time + 1;
            
            // æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨
            const volatility = 0.5;
            const trend = Math.sin(Date.now() / 10000) * 0.1;
            currentPrice += (Math.random() - 0.5) * volatility + trend;

            const newPoint = { time: newTime, value: currentPrice };
            realtimeData.push(newPoint);
            
            // ä¿æŒæœ€è¿‘ 200 ä¸ªæ•°æ®ç‚¹
            if (realtimeData.length > 200) {
                realtimeData.shift();
            }

            realtimeSeries.update(newPoint);
            
            // æ›´æ–° EMA
            updateEMA();

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
        }

        function updateStats() {
            document.getElementById('current-price').textContent = 
                `$${currentPrice.toFixed(2)}`;
            
            const priceChange = realtimeData.length > 1 
                ? ((currentPrice - realtimeData[0].value) / realtimeData[0].value * 100).toFixed(2)
                : '0.00';
            
            const changeElement = document.getElementById('price-change');
            changeElement.textContent = `${priceChange >= 0 ? '+' : ''}${priceChange}%`;
            changeElement.className = `stat-change ${priceChange >= 0 ? 'positive' : 'negative'}`;

            // è®¡ç®— 24h é«˜ä½
            const prices = realtimeData.map(d => d.value);
            const high24h = Math.max(...prices);
            const low24h = Math.min(...prices);
            
            document.getElementById('high-24h').textContent = `$${high24h.toFixed(2)}`;
            document.getElementById('low-24h').textContent = `$${low24h.toFixed(2)}`;
            document.getElementById('volume-24h').textContent = 
                (Math.random() * 1000000 + 500000).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // åˆ‡æ¢å®æ—¶æ›´æ–°
        document.getElementById('toggle-realtime').addEventListener('click', function() {
            isRealTimeActive = !isRealTimeActive;
            this.textContent = isRealTimeActive ? 'æš‚åœå®æ—¶æ›´æ–°' : 'æ¢å¤å®æ—¶æ›´æ–°';
            document.getElementById('live-status').textContent = 
                isRealTimeActive ? 'â— LIVE' : 'â— PAUSED';
            document.getElementById('live-status').className = 
                `status-badge ${isRealTimeActive ? 'live' : 'paused'}`;
        });

        function clearRealtimeData() {
            realtimeData = [];
            currentPrice = 100;
            initializeRealtimeData();
        }

        function changeInterval() {
            const intervals = [500, 1000, 2000];
            const currentIndex = intervals.indexOf(updateInterval);
            updateInterval = intervals[(currentIndex + 1) % intervals.length];
            alert(`æ›´æ–°é¢‘ç‡å·²æ”¹ä¸º ${updateInterval}ms`);
        }

        // ========== RSI æŒ‡æ ‡ ==========
        const rsiChart = LightweightCharts.createChart(document.getElementById('rsi-chart'), {
            width: document.getElementById('rsi-chart').clientWidth,
            height: 400,
            layout: {
                background: { color: '#16161e' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2a3e' },
                horzLines: { color: '#2a2a3e' },
            },
        });

        const rsiSeries = rsiChart.addSeries(LightweightCharts.LineSeries, {
            color: '#2962FF',
            lineWidth: 2,
        });

        // æ·»åŠ è¶…ä¹°è¶…å–çº¿
        const overboughtLine = rsiChart.addSeries(LightweightCharts.LineSeries, {
            color: '#ef5350',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
        });

        const oversoldLine = rsiChart.addSeries(LightweightCharts.LineSeries, {
            color: '#26a69a',
            lineWidth: 1,
            lineStyle: LightweightCharts.LineStyle.Dashed,
            priceLineVisible: false,
        });

        function calculateRSI(data, period = 14) {
            const rsi = [];
            let gains = 0;
            let losses = 0;

            for (let i = 1; i < data.length; i++) {
                const change = data[i].value - data[i - 1].value;
                
                if (i <= period) {
                    gains += change > 0 ? change : 0;
                    losses += change < 0 ? -change : 0;
                } else {
                    const avgGain = gains / period;
                    const avgLoss = losses / period;
                    const rs = avgGain / avgLoss;
                    const rsiValue = 100 - (100 / (1 + rs));
                    
                    rsi.push({ time: data[i].time, value: rsiValue });

                    gains = (gains * (period - 1) + (change > 0 ? change : 0)) / period;
                    losses = (losses * (period - 1) + (change < 0 ? -change : 0)) / period;
                }
            }
            return rsi;
        }

        function updateRSI() {
            const rsiData = calculateRSI(realtimeData);
            if (rsiData.length > 0) {
                rsiSeries.setData(rsiData);
                
                // è¶…ä¹°çº¿ (70)
                overboughtLine.setData(rsiData.map(d => ({ time: d.time, value: 70 })));
                // è¶…å–çº¿ (30)
                oversoldLine.setData(rsiData.map(d => ({ time: d.time, value: 30 })));
            }
        }

        // ========== MACD æŒ‡æ ‡ ==========
        const macdChart = LightweightCharts.createChart(document.getElementById('macd-chart'), {
            width: document.getElementById('macd-chart').clientWidth,
            height: 400,
            layout: {
                background: { color: '#16161e' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2a3e' },
                horzLines: { color: '#2a2a3e' },
            },
        });

        const macdLine = macdChart.addSeries(LightweightCharts.LineSeries, {
            color: '#2962FF',
            lineWidth: 2,
        });

        const signalLine = macdChart.addSeries(LightweightCharts.LineSeries, {
            color: '#FF6B6B',
            lineWidth: 2,
        });

        const macdHistogram = macdChart.addSeries(LightweightCharts.HistogramSeries, {
            color: '#26a69a',
            priceFormat: {
                type: 'volume',
            },
        });

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            
            const macd = [];
            for (let i = 0; i < ema12.length; i++) {
                macd.push({
                    time: ema12[i].time,
                    value: ema12[i].value - ema26[i].value
                });
            }
            
            const signal = calculateEMA(macd, 9);
            
            const histogram = [];
            for (let i = 0; i < signal.length; i++) {
                const macdValue = macd[i + (macd.length - signal.length)].value;
                const histValue = macdValue - signal[i].value;
                histogram.push({
                    time: signal[i].time,
                    value: histValue,
                    color: histValue >= 0 ? '#26a69a' : '#ef5350'
                });
            }
            
            return { macd, signal, histogram };
        }

        function updateMACD() {
            const { macd, signal, histogram } = calculateMACD(realtimeData);
            if (macd.length > 0) {
                macdLine.setData(macd);
                signalLine.setData(signal);
                macdHistogram.setData(histogram);
            }
        }

        // ========== æ·±åº¦å›¾ ==========
        const depthChart = LightweightCharts.createChart(document.getElementById('depth-chart'), {
            width: document.getElementById('depth-chart').clientWidth,
            height: 400,
            layout: {
                background: { color: '#16161e' },
                textColor: '#d1d4dc',
            },
            grid: {
                vertLines: { color: '#2a2a3e' },
                horzLines: { color: '#2a2a3e' },
            },
        });

        const bidsSeries = depthChart.addSeries(LightweightCharts.AreaSeries, {
            topColor: 'rgba(38, 166, 154, 0.4)',
            bottomColor: 'rgba(38, 166, 154, 0.0)',
            lineColor: 'rgba(38, 166, 154, 1)',
            lineWidth: 2,
        });

        const asksSeries = depthChart.addSeries(LightweightCharts.AreaSeries, {
            topColor: 'rgba(239, 83, 80, 0.4)',
            bottomColor: 'rgba(239, 83, 80, 0.0)',
            lineColor: 'rgba(239, 83, 80, 1)',
            lineWidth: 2,
        });

        function generateDepthData() {
            const bids = [];
            const asks = [];
            const midPrice = currentPrice;
            let cumVolume = 0;

            // ä¹°å•
            for (let i = 20; i >= 0; i--) {
                const price = midPrice - i * 0.5;
                cumVolume += Math.random() * 10000 + 5000;
                bids.push({ time: price, value: cumVolume });
            }

            cumVolume = 0;
            // å–å•
            for (let i = 0; i <= 20; i++) {
                const price = midPrice + i * 0.5;
                cumVolume += Math.random() * 10000 + 5000;
                asks.push({ time: price, value: cumVolume });
            }

            return { bids, asks };
        }

        function updateDepthData() {
            const { bids, asks } = generateDepthData();
            bidsSeries.setData(bids);
            asksSeries.setData(asks);
        }

        let depthAnimationEnabled = true;
        function toggleDepthAnimation() {
            depthAnimationEnabled = !depthAnimationEnabled;
        }

        // ========== åˆå§‹åŒ–å’Œå®šæ—¶æ›´æ–° ==========
        initializeRealtimeData();
        updateRSI();
        updateMACD();
        updateDepthData();

        // ä¸»æ›´æ–°å¾ªç¯
        setInterval(() => {
            updateRealtimeData();
            if (realtimeData.length > 20) {
                updateRSI();
                updateMACD();
            }
            if (depthAnimationEnabled) {
                updateDepthData();
            }
        }, updateInterval);

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
            const charts = [
                { chart: realtimeChart, id: 'realtime-chart' },
                { chart: rsiChart, id: 'rsi-chart' },
                { chart: macdChart, id: 'macd-chart' },
                { chart: depthChart, id: 'depth-chart' },
            ];

            charts.forEach(({ chart, id }) => {
                const container = document.getElementById(id);
                chart.applyOptions({ width: container.clientWidth });
            });
        });
        } // ç»“æŸ initCharts å‡½æ•°
    </script>
</body>
</html>

